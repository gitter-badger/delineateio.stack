version: 2
jobs:

  validate_dev:
    docker:
      - image: circleci/python:latest
    steps:
      - checkout
      - run: bash dev/valdiate.sh


  validate_ops:
    docker:
      - image: circleci/python:latest
    steps:
      - checkout
      - run: bash ops/provision/validate.sh
      - run: bash ops/deploy/validate.sh


  unit_tests:
    docker:
      - image: circleci/python:latest
    steps:
      - checkout
      - run: echo "Runs the PyTest test cases"


  provision_masters:
    docker:
      - image: circleci/python:latest
    steps:
      - checkout
      - run: bash ops/scripts/hashicorp_install.sh "packer" "1.1.3"
      - run: cd ops/provision && ./provision.sh "master"
      - run: bash ops/provision/get_image_id.sh /home/circleci/project/state "master" 
      - persist_to_workspace:
          root: state
          paths:
            - master.id


  provision_nodes:
    docker:
      - image: circleci/python:latest
    steps:
      - checkout
      - run: bash ops/scripts/hashicorp_install.sh "packer" "1.1.3"
      - run: cd ops/provision && ./provision.sh "node"
      - run: bash ops/provision/get_image_id.sh /home/circleci/project/state "node" 
      - persist_to_workspace:
          root: state
          paths:
            - node.id


  deploy:
    docker:
      - image: circleci/python:latest
    steps:
      - checkout
      - attach_workspace:
          at: state
      - run: bash ops/provision/get_image_ids.sh state
      - run: bash ops/scripts/hashicorp_install.sh "terraform" "0.11.2"
      - run: bash ops/deploy/deploy.sh "$(cat state/image.ids)"
      - run: mv ops/deploy/terraform.tfstate state/terraform.tfstate
      - persist_to_workspace:
          root: state
          paths:
            - terraform.tfstate
            - image_ids.id


  integration_tests:
    docker:
      - image: circleci/python:latest
    steps:
      - checkout
      - run: echo "Integrated Ops tests here"
      - run: echo "Integrated Feature tests here"


  destroy:
    docker:
      - image: circleci/python:latest
    steps:
      - checkout
      - attach_workspace:
          at: state
      - run: bash ops/scripts/hashicorp_install.sh "terraform" "0.11.2"
      - run: bash ops/scripts/do_install.sh "1.7.1"
      - run: mv state/terraform.tfstate ops/deploy/terraform.tfstate
      - run: bash ops/deploy/destroy.sh "$(cat state/image.ids)" /home/circleci/project/state


workflows:
  version: 2
  pipeline:
    jobs:
      - validate_dev
      - validate_ops
      - unit_tests:
          requires:
            - validate_dev
      - provision_masters:
          requires:
            - validate_ops
      - provision_nodes:
          requires:
            - validate_ops
      - deploy:
          requires:
            - unit_tests
            - provision_masters
            - provision_nodes
      - integration_tests:
          requires:
              - deploy
      - destroy_approval: 
          type: approval
          requires:
           - integration_tests
      - destroy:
          requires:
            - destroy_approval
